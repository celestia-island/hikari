# Hikari Demo App Build System
#
# Usage:
#   just                - List all available recipes
#   just serve          - Build client and start server (recommended)
#   just build-client   - Build WASM client only
#   just run-server     - Start Axum server
#   just clean          - Clean build artifacts

# Configure Windows to use PowerShell (UTF-8 encoding)
set windows-shell := ["pwsh.exe", "-NoLogo", "-NoProfile", "-ExecutionPolicy", "Bypass", "-Command", "[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; $PSDefaultParameterValues['*:Encoding'] = 'utf8';"]

default:
    @just --list

# ============================================================================
# Build Commands - Axum + WASM Architecture
# ============================================================================

# Clean dist directory
clean-dist:
    @echo "Cleaning dist directory..."
    @if (Test-Path dist) { Remove-Item -Recurse -Force dist }

# Build workspace dependencies
build-deps:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Building workspace dependencies..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd ../../ && cargo build --workspace --bins
    @echo ""
    @echo "âœ… Dependencies built successfully"

# Compile SCSS files (optional - requires fixing SCSS variables)
build-styles:
    @echo ""
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Compiling SCSS styles..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Note: SCSS compilation currently disabled - using Tailwind CDN instead"
    @echo "To enable SCSS, fix variable names and paths in component SCSS files"
    @echo "Creating dist/assets directory..."
    @New-Item -ItemType Directory -Force -Path dist/assets | Out-Null
    @echo "âœ… Styles directory ready (using Tailwind CDN)"

# Build client (WASM + assets)
build-client: clean-dist build-deps build-styles
    @echo ""
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Building Client (WASM)..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Building WASM..."
    cargo build --lib --release --target wasm32-unknown-unknown
    @echo "Creating output directories..."
    @New-Item -ItemType Directory -Force -Path dist/assets | Out-Null
    @echo "Running wasm-bindgen..."
    wasm-bindgen target/wasm32-unknown-unknown/release/demo_app.wasm --out-dir dist/assets --target web --no-typescript
    @echo "Copying static assets..."
    @if (Test-Path index.html) { Copy-Item -Force index.html dist/index.html }
    @echo ""
    @echo "âœ… Client build complete!"

# Build server (Axum)
build-server: build-deps
    @echo ""
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Building Server..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cargo build --features server

# Build everything
build: build-client build-server

# ============================================================================
# Run Commands
# ============================================================================

# Start Axum development server
run-server: build-client
    @echo ""
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Starting Axum development server..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "ğŸŒ Server will be available at:"
    @echo "   â†’ http://localhost:3000"
    @echo ""
    @echo "Press Ctrl+C to stop the server"
    @echo ""
    cargo run --features server

# Alias for run-server
serve: run-server

# ============================================================================
# Development
# ============================================================================

# Format code
fmt:
    cargo fmt

# Check formatting
fmt-check:
    @echo "Checking code formatting..."
    cargo fmt -- --check

# Run Clippy
clippy:
    @echo "Running Clippy..."
    cargo clippy --all-targets -- -D warnings

# Full check (format + clippy)
check: fmt-check clippy
    @echo "âœ… All checks passed"

# ============================================================================
# Testing
# ============================================================================

# Run tests
test:
    cargo test

# ============================================================================
# Cleanup
# ============================================================================

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    cargo clean
    @if (Test-Path dist) { Remove-Item -Recurse -Force dist }
    @echo "ğŸ§¹ Cleaned successfully"

# Clean everything (including workspace dependencies)
clean-all:
    @echo "Cleaning all build artifacts (workspace + demo)..."
    cd ../../ && cargo clean
    cargo clean
    @if (Test-Path dist) { Remove-Item -Recurse -Force dist }
    @echo "ğŸ§¹ Cleaned all artifacts"

