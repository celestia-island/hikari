# Hikari Table Demo Build System
#
# Usage:
#   just                - List all available recipes
#   just serve          - Build client and run server (recommended)
#   just build-client   - Build WASM only
#   just build-server   - Build server binary
#   just clean          - Clean build artifacts

# Configure Windows to use PowerShell (UTF-8 encoding)
set windows-shell := ["pwsh.exe", "-NoLogo", "-NoProfile", "-ExecutionPolicy", "Bypass", "-Command", "[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; $PSDefaultParameterValues['*:Encoding'] = 'utf8';"]

default:
    @just --list

# ============================================================================
# Axum + WASM Architecture (Recommended)
# ============================================================================

# Build WASM client
build-client:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Building WASM client..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cargo build --lib --target wasm32-unknown-unknown
    @echo ""
    @echo "ğŸ”§ Binding WASM..."
    wasm-bindgen --target web --out-dir ./dist/assets --no-typescript target/wasm32-unknown-unknown/debug/table_demo.wasm
    @echo ""
    @echo "âœ… WASM client built successfully"
    @echo ""
    @echo "ğŸ“¦ Output: dist/assets/"

# Build server binary
build-server:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Building Axum server..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cargo build --bin table-demo --features server
    @echo ""
    @echo "âœ… Server binary built successfully"

# Build client and run server (one-click start)
serve: build-client
    @echo ""
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "Starting development server..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "ğŸŒ Server will be available at:"
    @echo "   â†’ http://localhost:3000"
    @echo ""
    @echo "Press Ctrl+C to stop the server"
    @echo ""
    cargo run --bin table-demo --features server

# Alias for serve
run-server: serve

# ============================================================================
# Development
# ============================================================================

# Format code
fmt:
    cargo fmt

# Check formatting
fmt-check:
    @echo "Checking code formatting..."
    cargo fmt -- --check

# Run Clippy
clippy:
    @echo "Running Clippy..."
    cargo clippy --all-targets -- -D warnings

# Full check (format + clippy)
check: fmt-check clippy
    @echo "âœ… All checks passed"

# ============================================================================
# Testing
# ============================================================================

# Run tests
test:
    cargo test

# ============================================================================
# Cleanup
# ============================================================================

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    cargo clean
    @echo "ğŸ§¹ Cleaned successfully"

# Clean everything (including dist)
clean-all: clean
    @echo "Cleaning dist folder..."
    rm -rf dist
    @echo "ğŸ§¹ Cleaned all artifacts"
